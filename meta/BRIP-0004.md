---
mip: 0004
title: Enshrined Proof of Liquidity Reward Distribution
author: rezbera, calbera
status: Draft
created: 2025-06-19
type: Core
requires: BRIP-0001
---

## Summary

This BRIP proposes enshrining the `distributeFor` function call into the execution layer, enabling automatic validator reward distribution at the beginning of each block without relying on external transactions or bots. This change eliminates gas costs and timing dependencies for Proof of Liquidity reward distribution, enabling real-time reward processing and improved network economics.

## Motivation

Berachain's Proof of Liquidity consensus mechanism requires regular distribution of block rewards to validators based on their liquidity provision. Currently, this distribution relies on external actors calling the `distributeFor` function, which presents several limitations:

1. **Gas Dependency**: Distribution transactions compete with user transactions for block space and are subject to gas price fluctuations
2. **Timing Uncertainty**: No guarantee that reward distribution occurs promptly after each block
3. **Bot Infrastructure**: Requires maintaining external infrastructure to monitor and trigger distributions
4. **Centralization Risk**: Dependence on specific actors to perform distributions creates potential points of failure
5. **Economic Inefficiency**: Gas costs for distribution reduce overall network economic efficiency

By enshrining `distributeFor` calls at the execution layer, similar to how `processBeaconBlockRoot` and `processWithdrawalQueue` are handled, we can guarantee that reward distribution occurs deterministically for every block without external dependencies.

## Specification

### Execution Layer Integration

Berachain Labs will implement automatic `distributeFor` function calls at the beginning of each block processing in both Geth and Reth forked execution clients, before regular transaction execution. This requires modifications to the block execution process in the forked clients.

### Contract Modifications

The `Distributor.sol` contract will require updates to support a new enshrined interface alongside the existing implementation:

#### New Enshrined Function Signature

A new simplified `distributeFor` function variant will be added that leverages validator information available from forkchoice attributes:

```solidity
function distributeFor(
    uint64 nextTimestamp,
    bytes calldata validatorPubkey
) external onlySystemCall;
```

#### Key Changes from Current Implementation

- **Removed proposer index and Merkle proofs**: The validator pubkey will be provided directly from forkchoice attributes, eliminating the need for cryptographic proof verification
- **Validator pubkey source**: The 48-byte BLS public key will be passed from the consensus layer via the `BerachainPayloadAttributes.validator_pubkey` field
- **Simplified verification**: Trust the consensus layer data rather than requiring on-chain proof verification
- **Access control**: Only the system address (`0xfffffffffffffffffffffffffffffffffffffffe`) can call this simplified version

#### Contract Interface Updates

1. Add the new simplified function variant for enshrined calls
2. Maintain backward compatibility with the existing proof-based function for external calls
3. Implement `onlySystemCall` modifier to restrict access to the system address (`0xfffffffffffffffffffffffffffffffffffffffe`)
4. Share common reward distribution logic between both function variants
5. **Preserve existing anti-double-claim mechanisms**: Both function variants will share the same timestamp-based history buffer system to prevent double-distribution during the hard fork transition

### Forkchoice Attributes Extension

Building on the foundation established in [PR #26](https://github.com/berachain/bera-reth/pull/26), the Geth and Reth execution layer implementations will:

1. Extract the `validator_pubkey` from `BerachainPayloadAttributes` in forkchoice updates
2. Pass this pubkey to the enshrined `distributeFor` call during block execution
3. Use the block timestamp as the `nextTimestamp` parameter

### Execution Flow

1. **Block Start**: Execution layer receives forkchoice update with validator pubkey
2. **Pre-Transaction Processing**: Before processing user transactions, call enshrined `distributeFor`
3. **Reward Distribution**: Process rewards for the proposing validator automatically
4. **Transaction Processing**: Continue with normal block execution

## Rationale

### Similar Ethereum Precedents

This approach follows established patterns in Ethereum for enshrined system operations:
- **[EIP-4788](https://eips.ethereum.org/EIPS/eip-4788) (processBeaconBlockRoot)**: Automatically stores beacon block roots for cryptographic verification
- **[EIP-4895](https://eips.ethereum.org/EIPS/eip-4895) (processWithdrawalQueue)**: Handles validator withdrawals as part of block execution

### Trust Model

The simplified approach eliminates the need for on-chain Merkle proof verification by trusting the consensus layer to provide accurate validator information. This is justified because:

1. The consensus layer already validates block proposer identity
2. The execution layer inherently trusts consensus layer data for block construction
3. Malicious consensus clients cannot profit from providing incorrect validator pubkeys
4. The change maintains the same security assumptions as other enshrined operations

### Performance Benefits

Enshrining eliminates:
- Gas costs for distribution transactions (estimated ~1,000,000 gas per distribution)
- Block space competition between distributions and user transactions
- Latency between block production and reward distribution

## Backward Compatibility

This change requires a hard fork to implement. The modification maintains backward compatibility by:

1. **Dual Interface**: Supporting both the new enshrined function and the existing proof-based function
2. **Existing Contracts**: All current reward allocation and distribution logic remains unchanged
3. **External Integration**: Third-party contracts and integrations continue to work without modification
4. **Shared Anti-Double-Claim Protection**: Both function variants will utilize the same timestamp-based history buffer system, ensuring no double-distribution can occur at the hard fork boundary or during the transition period

## Implementation Plan

### Phase 1: Contract Updates
- Modify `Distributor.sol` to support the new simplified enshrined interface alongside existing functionality
- Add `onlySystemCall` access controls for the new function variant
- Deploy and test updated contracts with dual interface support

### Phase 2: Execution Layer Integration
- Berachain Labs will implement enshrined `distributeFor` calls in both Geth and Reth forks
- Complete implementation of `BerachainEngineTypes` and custom payload handling
- Integrate automatic `distributeFor` calls into block execution process before transaction processing
- Add comprehensive testing for reward distribution timing and execution layer integration

### Phase 3: Network Deployment
- Coordinate hard fork activation across network participants
- Monitor initial performance and adjust parameters if necessary
- Decommission external distribution bot infrastructure

## Test Cases

1. **Normal Operation**: Verify automatic distribution occurs for each block with correct validator pubkey
2. **Missing Pubkey**: Handle cases where forkchoice attributes don't include validator pubkey
3. **Invalid Pubkey**: Gracefully handle malformed or invalid validator public keys
4. **Backward Compatibility**: Ensure existing external `distributeFor` calls continue to work
5. **Gas Accounting**: Verify enshrined calls don't consume user transaction gas
6. **Double-Claim Prevention**: 
   - Verify that calling both enshrined and external `distributeFor` for the same timestamp fails
   - Test that the shared history buffer prevents double-distribution during hard fork transition
   - Validate that processed timestamps are preserved across the upgrade
7. **Hard Fork Boundary**: Test distribution behavior immediately before, during, and after hard fork activation

## Security Considerations

### Hard Fork Transition Security
- **Double-Claim Prevention**: Both enshrined and external `distributeFor` functions will share the same timestamp-based history buffer system (`_processedTimestampsBuffer`) to prevent double-distribution during the transition
- **Buffer State Preservation**: The processed timestamps buffer must be preserved across the hard fork upgrade to maintain continuity of anti-double-claim protection
- **Transition Monitoring**: Implement comprehensive logging to track both enshrined and external distributions during the transition period

### Execution Layer Trust
- The consensus layer must be trusted to provide accurate validator pubkeys
- This matches existing trust assumptions for other enshrined operations
- Risk mitigation through extensive testing and gradual rollout

### Access Control
- Only the system address (`0xfffffffffffffffffffffffffffffffffffffffe`) should be able to call the simplified `distributeFor` function
- Prevent unauthorized calls that could manipulate reward distribution
- Maintain audit trails for distribution activities
- Preserve existing access controls for the proof-based function variant

### Economic Impact
- Monitor reward distribution patterns for any unexpected behavior
- Ensure gas savings don't create unintended economic incentives
- Validate that real-time distribution doesn't affect validator behavior

### Denial of Service
- Ensure enshrined calls cannot be used to attack block execution
- Implement proper error handling to prevent block production failures
- Consider gas limits and execution time bounds

## Reference Implementation

The reference implementation builds upon:
- **[PR #26](https://github.com/berachain/bera-reth/pull/26)**: Foundation for `BerachainPayloadAttributes` with validator pubkey support
- **[Distributor.sol](https://github.com/berachain/contracts/blob/main/src/pol/rewards/Distributor.sol)**: Current implementation of reward distribution logic
- **Ethereum EIPs**: [EIP-4788](https://eips.ethereum.org/EIPS/eip-4788) and [EIP-4895](https://eips.ethereum.org/EIPS/eip-4895) as models for enshrined system operations

## Copyright

All copyrights and related rights in this work are waived under CCO 1.0 Universal.